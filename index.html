<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=5, user-scalable=yes">
  <meta name="theme-color" content="#0070d1">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <title>Calculadora de Sub-Redes IPv6</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <style>
    /* Importação de fontes */
    @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');
    
    /* Variáveis básicas */
    :root {
      --font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      
      /* Cores principais */
      --primary-color: #0070d1;
      --primary-light: #2689db;
      --primary-dark: #0056a3;
      
      /* Cores secundárias */
      --secondary-color: #4caf50;
      --secondary-light: #66bb6a;
      --secondary-dark: #2e7d32;
      
      /* Cores de alerta e erro */
      --error-color: #e53935;
      --error-light: #ffebee;
      --warning-color: #ffa000;
      --success-color: #4caf50;
      
      /* Tons neutros - Modo Claro */
      --text-light: #24292f;
      --text-light-secondary: #57606a;
      --bg-light: #ffffff;
      --bg-light-accent: #f6f8fa;
      --border-light: #d0d7de;
      
      /* Tons neutros - Modo Escuro */
      --text-dark: #e6edf3;
      --text-dark-secondary: #8b949e;
      --bg-dark: #0d1117;
      --bg-dark-accent: #161b22;
      --border-dark: #30363d;
      
      /* Elementos específicos */
      --blur-amount: 10px;
      --container-shadow: 0 8px 30px rgba(0,0,0,0.12);
      --card-shadow: 0 2px 8px rgba(0,0,0,0.08);
      --border-radius: 8px;
      --border-radius-sm: 4px;
      
      /* Transições */
      --transition-fast: 150ms ease;
      --transition-normal: 250ms ease;
    }
    
    /* Configuração global */
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }
    
    html {
      scroll-behavior: smooth;
    }
    
    body {
      font-family: var(--font-family);
      font-size: 16px;
      line-height: 1.5;
      color: var(--text-light);
      background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
      min-height: 100vh;
      padding: 0;
      margin: 0;
      transition: color var(--transition-normal), background-color var(--transition-normal);
    }
    
    /* Container principal */
    .container {
      max-width: 1200px;
      margin: 24px auto;
      background: rgba(255, 255, 255, 0.95);
      backdrop-filter: blur(var(--blur-amount));
      -webkit-backdrop-filter: blur(var(--blur-amount));
      border-radius: var(--border-radius);
      padding: 32px;
      box-shadow: var(--container-shadow);
      transition: background-color var(--transition-normal);
    }
    
    /* Modo escuro */
    body.dark-mode {
      background: linear-gradient(135deg, #1f2937 0%, #111827 100%);
      color: var(--text-dark);
    }
    
    body.dark-mode .container {
      background: rgba(13, 17, 23, 0.92);
      box-shadow: 0 8px 30px rgba(0, 0, 0, 0.3);
    }
    
    body.dark-mode h1, 
    body.dark-mode h2, 
    body.dark-mode h3, 
    body.dark-mode h4,
    body.dark-mode label {
      color: var(--text-dark);
    }
    
    /* Cabeçalho */
    .header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      flex-wrap: wrap;
      gap: 16px;
      margin-bottom: 24px;
      border-bottom: 1px solid rgba(0, 0, 0, 0.05);
      padding-bottom: 16px;
    }
    
    body.dark-mode .header {
      border-bottom: 1px solid rgba(255, 255, 255, 0.05);
    }
    
    .header h1 {
      margin: 0;
      font-size: 28px;
      font-weight: 700;
      color: var(--text-light);
      transition: color var(--transition-normal);
    }
    
    .header-buttons {
      display: flex;
      gap: 12px;
      flex-wrap: wrap;
    }
    
    /* Layout principal em grid */
    .main-layout {
      display: grid;
      grid-template-columns: 1fr minmax(auto, 320px);
      gap: 32px;
    }
    
    /* Botões */
    button {
      cursor: pointer;
      font-family: var(--font-family);
      font-weight: 500;
      border: none;
      border-radius: var(--border-radius-sm);
      padding: 10px 16px;
      transition: all var(--transition-fast);
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      white-space: nowrap;
      outline: none;
    }
    
    .btn-primary,
    .btn-secondary {
      font-size: 14px;
      font-weight: 500;
      width: auto;
      color: white;
      height: 40px;
      box-shadow: 0 1px 2px rgba(0, 0, 0, 0.05);
    }
    
    .btn-primary {
      background-color: var(--primary-color);
      color: white;
    }
    
    .btn-primary:hover, 
    .btn-primary:focus {
      background-color: var(--primary-light);
      transform: translateY(-1px);
      box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
    }
    
    .btn-secondary {
      background-color: var(--secondary-color);
      color: white;
    }
    
    .btn-secondary:hover, 
    .btn-secondary:focus {
      background-color: var(--secondary-light);
      transform: translateY(-1px);
      box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
    }
    
    #resetBtn {
      background-color: var(--error-color);
    }
    
    #resetBtn:hover, 
    #resetBtn:focus {
      background-color: #f44336;
    }
    
    /* Formulário */
    .form-group {
      margin-bottom: 24px;
    }
    
    label {
      display: block;
      margin-bottom: 8px;
      font-weight: 600;
      color: var(--text-light);
      transition: color var(--transition-normal);
    }
    
    input {
      display: block;
      width: 100%;
      padding: 12px;
      font-size: 16px;
      border: 1px solid var(--border-light);
      border-radius: var(--border-radius-sm);
      transition: all var(--transition-fast);
      background-color: white;
      color: var(--text-light);
    }
    
    input:focus {
      border-color: var(--primary-color);
      box-shadow: 0 0 0 3px rgba(0, 112, 209, 0.2);
    }
    
    /* Cards */
    .card {
      background-color: var(--bg-light-accent);
      border: 1px solid var(--border-light);
      border-radius: var(--border-radius);
      padding: 20px;
      box-shadow: var(--card-shadow);
      margin-bottom: 24px;
      transition: all var(--transition-normal);
    }
    
    .card h3 {
      margin: 0 0 16px 0;
      font-weight: 600;
      font-size: 18px;
      color: var(--primary-color);
    }
    
    body.dark-mode .card {
      background-color: var(--bg-dark-accent);
      border-color: var(--border-dark);
    }
    
    /* Tabs */
    .tabs {
      display: flex;
      border-bottom: 1px solid var(--border-light);
      margin-bottom: 20px;
      overflow-x: auto;
      scrollbar-width: thin;
    }
    
    .tab {
      padding: 10px 20px;
      background: none;
      border: none;
      border-bottom: 3px solid transparent;
      cursor: pointer;
      font-weight: 500;
      color: var(--text-light-secondary);
      transition: all 0.2s ease;
      white-space: nowrap;
    }
    
    .tab:hover {
      color: var(--primary-color);
    }
    
    .tab-active {
      color: var(--primary-color);
      border-bottom-color: var(--primary-color);
    }
    
    body.dark-mode .tab {
      color: var(--text-dark-secondary);
    }
    
    body.dark-mode .tab:hover,
    body.dark-mode .tab-active {
      color: var(--primary-light);
      border-bottom-color: var(--primary-light);
    }
    
    /* Conteúdo dos tabs */
    .tab-content {
      display: none;
      padding: 10px 0;
      animation: fadeIn 0.3s ease-in-out;
    }
    
    .tab-content.active {
      display: block;
    }
    
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }
    
    /* Tabelas */
    .table-container {
      width: 100%;
      overflow-x: auto;
      margin-bottom: 20px;
    }
    
    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 16px;
      border-radius: var(--border-radius-sm);
      overflow: hidden;
      box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05);
    }
    
    table th {
      background-color: var(--bg-light-accent);
      padding: 12px;
      text-align: left;
      font-weight: 600;
      border: 1px solid var(--border-light);
      transition: all var(--transition-normal);
    }
    
    table td {
      padding: 12px;
      border: 1px solid var(--border-light);
      transition: all var(--transition-normal);
    }
    
    table tr:hover td {
      background-color: rgba(0, 0, 0, 0.02);
    }
    
    body.dark-mode table th {
      background-color: var(--bg-dark-accent);
      border-color: var(--border-dark);
      color: var(--text-dark);
    }
    
    body.dark-mode table td {
      background-color: var(--bg-dark-accent);
      border-color: var(--border-dark);
      color: var(--text-dark);
    }
    
    /* Lista de IPs */
    .ip-list {
      list-style: none;
      padding: 0;
      margin: 0;
    }
    
    .ip-item {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 12px;
      margin: 8px 0;
      border: 1px solid var(--border-light);
      border-radius: var(--border-radius-sm);
      background-color: white;
      transition: all var(--transition-fast);
    }
    
    body.dark-mode .ip-item {
      background-color: var(--bg-dark-accent);
      border-color: var(--border-dark);
    }
    
    .ip-number {
      width: 30px;
      text-align: right;
      color: var(--text-light-secondary);
      font-size: 13px;
      font-weight: 500;
    }
    
    body.dark-mode .ip-number {
      color: var(--text-dark-secondary);
    }
    
    .ip-text {
      flex: 1;
      font-family: 'SFMono-Regular', Consolas, 'Liberation Mono', Menlo, monospace;
      font-size: 14px;
    }
    
    /* Botão copiar */
    .copy-btn {
      background-color: var(--primary-color);
      color: white;
      border-radius: var(--border-radius-sm);
      height: 32px;
      padding: 0 12px;
      font-size: 14px;
    }
    
    .copy-btn:hover {
      background-color: var(--primary-light);
    }
    
    /* Visualização de dados */
    .chart-container {
      width: 100%;
      height: 400px;
      margin: 20px 0;
    }
    
    /* Sidebar */
    .sidebar {
      background-color: var(--bg-light-accent);
      border: 1px solid var(--border-light);
      border-radius: var(--border-radius);
      padding: 20px;
      box-shadow: var(--card-shadow);
      position: sticky;
      top: 20px;
    }
    
    .sidebar h3 {
      margin: 0 0 16px 0;
      color: var(--primary-color);
      font-weight: 600;
      font-size: 18px;
    }
    
    body.dark-mode .sidebar {
      background-color: var(--bg-dark-accent);
      border-color: var(--border-dark);
    }
    
    body.dark-mode .sidebar h3 {
      color: var(--primary-light);
    }
    
    /* Info block */
    .info-item {
      margin-bottom: 16px;
    }
    
    .info-label {
      display: block;
      font-weight: 600;
      font-size: 14px;
      color: var(--text-light-secondary);
      margin-bottom: 6px;
    }
    
    .info-value-container {
      display: flex;
      align-items: center;
      gap: 8px;
    }
    
    .info-value {
      flex: 1;
      background-color: var(--bg-light-accent);
      padding: 10px 12px;
      border-radius: var(--border-radius-sm);
      font-family: 'SFMono-Regular', Consolas, 'Liberation Mono', Menlo, monospace;
      font-size: 14px;
      color: var(--primary-color);
      border: 1px solid var(--border-light);
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    
    body.dark-mode .info-label {
      color: var(--text-dark-secondary);
    }
    
    body.dark-mode .info-value {
      background-color: rgba(45, 55, 72, 0.8);
      color: #63b3ed;
      border-color: var(--border-dark);
    }
    
    /* Mensagens de erro */
    .error-message {
      color: var(--error-color);
      font-weight: 500;
      margin: 12px 0;
      padding: 12px 16px;
      background-color: var(--error-light);
      border-radius: var(--border-radius-sm);
      border-left: 4px solid var(--error-color);
      display: none;
    }
    
    /* Loading Indicator */
    .loader-container {
      display: none;
      align-items: center;
      justify-content: center;
      margin: 25px 0;
      padding: 24px;
      background-color: rgba(255, 255, 255, 0.7);
      border-radius: var(--border-radius);
      backdrop-filter: blur(4px);
    }
    
    body.dark-mode .loader-container {
      background-color: rgba(13, 17, 23, 0.7);
    }
    
    .loader {
      border: 3px solid rgba(0, 0, 0, 0.1);
      border-radius: 50%;
      border-top: 3px solid var(--primary-color);
      width: 24px;
      height: 24px;
      animation: spin 0.8s linear infinite;
    }
    
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    
    .loading-message {
      margin-left: 16px;
      font-weight: 500;
      color: var(--text-light);
    }
    
    body.dark-mode .loading-message {
      color: var(--text-dark);
    }
    
    /* Botões de ação */
    .action-buttons {
      display: flex;
      flex-wrap: wrap;
      gap: 12px;
      margin: 16px 0;
    }
    
    .full-width-button {
      width: 100%;
      justify-content: center;
    }
    
    /* Navegação fixada */
    .nav-buttons {
      position: fixed;
      right: 24px;
      bottom: 24px;
      display: flex;
      flex-direction: column;
      gap: 12px;
      z-index: 1000;
    }
    
    .nav-btn {
      width: 44px;
      height: 44px;
      border-radius: 50%;
      background-color: var(--primary-color);
      color: white;
      font-size: 20px;
      display: flex;
      align-items: center;
      justify-content: center;
      box-shadow: 0 3px 10px rgba(0, 0, 0, 0.2);
    }
    
    .nav-btn:hover {
      background-color: var(--primary-light);
      transform: translateY(-2px) scale(1.05);
      box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
    }
    
    /* Prefixes list */
    .prefixes-list {
      max-height: 300px;
      overflow-y: auto;
      border: 1px solid var(--border-light);
      border-radius: var(--border-radius-sm);
      margin-top: 10px;
    }
    
    .prefix-item {
      padding: 10px 12px;
      cursor: pointer;
      transition: background-color var(--transition-fast);
      border-bottom: 1px solid var(--border-light);
    }
    
    .prefix-item:last-child {
      border-bottom: none;
    }
    
    .prefix-item:hover {
      background-color: rgba(0, 112, 209, 0.1);
    }
    
    body.dark-mode .prefixes-list {
      border-color: var(--border-dark);
    }
    
    body.dark-mode .prefix-item {
      border-color: var(--border-dark);
    }
    
    body.dark-mode .prefix-item:hover {
      background-color: rgba(0, 112, 209, 0.2);
    }
    
    /* Step indicator */
    .steps {
      display: flex;
      margin-bottom: 20px;
      overflow-x: auto;
      padding-bottom: 10px;
    }
    
    .step {
      display: flex;
      align-items: center;
      margin-right: 24px;
      opacity: 0.6;
      transition: opacity 0.3s ease;
    }
    
    .step:last-child {
      margin-right: 0;
    }
    
    .step.active {
      opacity: 1;
    }
    
    .step-number {
      display: flex;
      align-items: center;
      justify-content: center;
      width: 28px;
      height: 28px;
      border-radius: 50%;
      background-color: var(--primary-color);
      color: white;
      font-weight: bold;
      margin-right: 10px;
    }
    
    .step-title {
      font-weight: 500;
    }
    
    /* Card de visualização */
    .visualization-controls {
      margin-bottom: 20px;
    }
    
    .stats-cards {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
      gap: 16px;
      margin: 20px 0;
    }
    
    .stat-card {
      background-color: var(--bg-light-accent);
      border: 1px solid var(--border-light);
      border-radius: var(--border-radius-sm);
      padding: 16px;
      text-align: center;
    }
    
    .stat-title {
      font-size: 14px;
      color: var(--text-light-secondary);
      margin-bottom: 8px;
    }
    
    .stat-value {
      font-size: 22px;
      font-weight: 600;
      color: var(--primary-color);
    }
    
    body.dark-mode .stat-card {
      background-color: var(--bg-dark-accent);
      border-color: var(--border-dark);
    }
    
    body.dark-mode .stat-title {
      color: var(--text-dark-secondary);
    }
    
    body.dark-mode .stat-value {
      color: var(--primary-light);
    }
    
    /* Responsividade */
    @media (max-width: 992px) {
      .main-layout {
        grid-template-columns: 1fr;
      }
      
      .sidebar {
        order: -1;
        position: static;
        margin-bottom: 24px;
      }
    }
    
    @media (max-width: 768px) {
      .container {
        padding: 20px;
        margin: 12px;
      }
      
      .header {
        flex-direction: column;
        align-items: flex-start;
      }
      
      .header h1 {
        font-size: 24px;
        width: 100%;
        text-align: center;
        margin-bottom: 16px;
      }
      
      .header-buttons {
        width: 100%;
        justify-content: space-between;
      }
      
      .steps {
        flex-wrap: wrap;
      }
      
      .step {
        margin-bottom: 10px;
      }
      
      .tabs {
        flex-wrap: wrap;
      }
      
      .tab {
        flex: 1;
        text-align: center;
        min-width: 120px;
      }
      
      .stats-cards {
        grid-template-columns: 1fr;
      }
      
      .action-buttons {
        flex-direction: column;
      }
      
      input {
        font-size: 16px;
        height: 48px;
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <h1>Calculadora de Sub-Redes IPv6</h1>
      <div class="header-buttons">
        <button id="resetBtn" class="btn-secondary">
          <i class="fas fa-undo-alt"></i> Limpar
        </button>
        <button id="toggleThemeBtn" class="btn-secondary">
          <i class="fas fa-moon"></i> Tema
        </button>
      </div>
    </div>
    
    <div class="steps">
      <div class="step active" id="step1">
        <div class="step-number">1</div>
        <div class="step-title">Bloco Inicial</div>
      </div>
      <div class="step" id="step2">
        <div class="step-number">2</div>
        <div class="step-title">Tamanho do Prefixo</div>
      </div>
      <div class="step" id="step3">
        <div class="step-number">3</div>
        <div class="step-title">Sub-Redes</div>
      </div>
      <div class="step" id="step4">
        <div class="step-number">4</div>
        <div class="step-title">Visualização</div>
      </div>
    </div>
    
    <div class="main-layout">
      <main class="main-content">
        <!-- Formulário principal -->
        <div class="form-group">
          <label for="ipv6">Endereço IPv6 (Formato CIDR, ex: 2001:db8::/41):</label>
          <input type="text" id="ipv6" placeholder="Ex: 2001:db8::/41" aria-label="Endereço IPv6">
          <div id="errorMessage" class="error-message"></div>
        </div>
        
        <button id="calcularBtn" class="btn-primary full-width-button">
          <i class="fas fa-calculator"></i> Calcular Sub-redes
        </button>
        
        <!-- Bloco principal -->
        <div id="mainBlockSection" class="card" style="display:none;">
          <h3>Bloco Principal: <span id="mainBlockCidr">N/A</span></h3>
          <p>Este é o bloco IPv6 a partir do qual as sub-redes serão criadas.</p>
          
          <div class="action-buttons">
            <button id="toggleMainBlockIpsBtn" class="btn-primary">
              <i class="fas fa-list"></i> Exibir IPs
            </button>
            <button id="continuarBtn" class="btn-secondary">
              <i class="fas fa-arrow-right"></i> Escolher Prefixo
            </button>
          </div>
          
          <div id="mainBlockIpsContainer" style="display:none;">
            <h4 style="margin-top: 20px; margin-bottom: 10px;">Lista de IPs do Bloco Principal</h4>
            <ul id="mainBlockIpsList" class="ip-list"></ul>
            <div class="action-buttons">
              <button id="resetMainBlockIPsButton" class="btn-secondary">
                <i class="fas fa-undo-alt"></i> Limpar Lista
              </button>
              <button id="moreMainBlockIpsBtn" class="btn-primary">
                <i class="fas fa-plus"></i> Gerar Mais 50 IPs
              </button>
            </div>
          </div>
        </div>
        
        <!-- Sugestões de prefixo -->
        <div id="suggestions" class="card" style="display:none;">
          <h3>Escolha o Tamanho do Prefixo</h3>
          <p>Selecione o tamanho do prefixo para divisão em sub-redes:</p>
          
          <div id="possiblePrefixesList" class="prefixes-list"></div>
        </div>
        
        <!-- Indicador de carregamento -->
        <div id="loadingIndicator" class="loader-container">
          <div class="loader"></div>
          <div class="loading-message">Gerando sub-redes. Por favor, aguarde...</div>
        </div>
        
        <!-- Tabela de sub-redes -->
        <div id="resultado" class="card" style="display:none;">
          <h3>Sub-redes Geradas</h3>
          
          <div class="table-container">
            <table id="subnetsTable">
              <thead>
                <tr>
                  <th>
                    <input type="checkbox" id="selectAll" aria-label="Selecionar todas as sub-redes">
                  </th>
                  <th>Sub-rede</th>
                  <th>Endereço Inicial</th>
                  <th>Endereço Final</th>
                  <th>Endereço de Rede</th>
                </tr>
              </thead>
              <tbody></tbody>
            </table>
          </div>
          
          <div id="loadMoreContainer" style="display:none; text-align: center; margin-top: 16px;">
            <button id="loadMoreButton" class="btn-secondary">
              <i class="fas fa-chevron-down"></i> Carregar Mais
            </button>
          </div>
          
          <div class="action-buttons">
            <button id="gerarIPsButton" class="btn-primary" style="display:none;">
              <i class="fas fa-network-wired"></i> Gerar IPs da Sub-rede Selecionada
            </button>
            <button id="visualizarBtn" class="btn-secondary">
              <i class="fas fa-chart-pie"></i> Visualizar Dados
            </button>
          </div>
          
          <!-- IPs da sub-rede selecionada -->
          <div id="ipsResult" class="card" style="display:none; margin-top: 20px;">
            <h3>IPs da Sub-rede Selecionada</h3>
            <ul id="ipsList" class="ip-list"></ul>
            <div class="action-buttons">
              <button id="resetIPsButton" class="btn-secondary">
                <i class="fas fa-undo-alt"></i> Limpar Lista
              </button>
              <button id="gerarMaisIPsButton" class="btn-primary">
                <i class="fas fa-plus"></i> Gerar Mais 50 IPs
              </button>
            </div>
          </div>
        </div>
        
        <!-- Visualização -->
        <div id="visualizationSection" class="card" style="display:none;">
          <h3>Visualização e Análise</h3>
          
          <div class="tabs">
            <button id="utilizationTab" class="tab tab-active">Utilização</button>
            <button id="heatmapTab" class="tab">Mapa de Calor</button>
            <button id="prefixComparisonTab" class="tab">Comparação de Prefixos</button>
          </div>
          
          <!-- Conteúdo de utilização -->
          <div id="utilizationContent" class="tab-content active">
            <p>Este gráfico mostra a distribuição e utilização do espaço de endereçamento IPv6 nas sub-redes geradas.</p>
            <div class="chart-container">
              <canvas id="utilizationChart"></canvas>
            </div>
          </div>
          
          <!-- Conteúdo de mapa de calor -->
          <div id="heatmapContent" class="tab-content">
            <p>O mapa de calor visualiza a densidade da alocação em diferentes partes do espaço de endereços IPv6.</p>
            <div class="chart-container">
              <div id="heatmapChart"></div>
            </div>
          </div>
          
          <!-- Conteúdo de comparação de prefixos -->
          <div id="prefixComparisonContent" class="tab-content">
            <p>Compare como diferentes tamanhos de prefixo afetam o número de sub-redes e endereços disponíveis.</p>
            
            <div class="visualization-controls">
              <div class="form-group">
                <label for="prefixSlider">Tamanho do Prefixo: <span id="prefixValue">64</span></label>
                <input type="range" id="prefixSlider" min="1" max="128" value="64" style="width: 100%;">
              </div>
            </div>
            
            <div class="stats-cards">
              <div class="stat-card">
                <div class="stat-title">Sub-redes</div>
                <div class="stat-value" id="statSubredes">0</div>
              </div>
              <div class="stat-card">
                <div class="stat-title">IPs por Sub-rede</div>
                <div class="stat-value" id="statIps">0</div>
              </div>
              <div class="stat-card">
                <div class="stat-title">Total de IPs</div>
                <div class="stat-value" id="statTotal">0</div>
              </div>
            </div>
            
            <div class="chart-container">
              <canvas id="prefixComparisonChart"></canvas>
            </div>
          </div>
        </div>
      </main>
      
      <!-- Sidebar -->
      <aside>
        <div id="infoSidebar" class="sidebar" style="display:none;">
          <h3>Informações do Bloco</h3>
          
          <div class="info-item">
            <span class="info-label">Bloco:</span>
            <div class="info-value-container">
              <span id="sidebarBlockCidr" class="info-value">N/A</span>
              <button class="copy-btn" title="Copiar Bloco" onclick="copiarTexto('sidebarBlockCidr')">
                <i class="fas fa-copy"></i>
              </button>
            </div>
          </div>
          
          <div class="info-item">
            <span class="info-label">Gateway:</span>
            <div class="info-value-container">
              <span id="mainBlockGateway" class="info-value">N/A</span>
              <button class="copy-btn" title="Copiar Gateway" onclick="copiarTexto('mainBlockGateway')">
                <i class="fas fa-copy"></i>
              </button>
            </div>
          </div>
          
          <div class="info-item">
            <span class="info-label">DNS Google:</span>
            <div class="info-value-container">
              <span id="googleDns" class="info-value">2001:4860:4860::8888</span>
              <button class="copy-btn" title="Copiar DNS" onclick="copiarTexto('googleDns')">
                <i class="fas fa-copy"></i>
              </button>
            </div>
          </div>
          
          <div class="info-item">
            <span class="info-label">DNS Alt:</span>
            <div class="info-value-container">
              <span id="googleDnsAlt" class="info-value">2001:4860:4860::8844</span>
              <button class="copy-btn" title="Copiar DNS Alt" onclick="copiarTexto('googleDnsAlt')">
                <i class="fas fa-copy"></i>
              </button>
            </div>
          </div>
        </div>
        
        <div id="aggregatedSidebar" class="sidebar" style="display:none;">
          <h3>Bloco Agregado</h3>
          <p>Quando você seleciona sub-redes contíguas, um bloco agregado é calculado automaticamente.</p>
          
          <div class="info-item">
            <span class="info-label">Prefixo Agregado:</span>
            <div class="info-value-container">
              <span id="aggregatedPrefix" class="info-value">N/A</span>
              <button class="copy-btn" title="Copiar Bloco Agregado" onclick="copiarTexto('aggregatedPrefix')">
                <i class="fas fa-copy"></i>
              </button>
            </div>
          </div>
        </div>
      </aside>
    </div>
  </div>
  
  <!-- Botões de navegação -->
  <div class="nav-buttons">
    <button class="nav-btn" id="topBtn" title="Ir para o topo" aria-label="Ir para o topo">
      <i class="fas fa-chevron-up"></i>
    </button>
    <button class="nav-btn" id="bottomBtn" title="Ir para o fim" aria-label="Ir para o fim">
      <i class="fas fa-chevron-down"></i>
    </button>
  </div>
  
  <!-- Scripts -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/d3/7.8.5/d3.min.js"></script>
  <script src="ipv6-calculator-enhanced.js"></script>
  
  <script>
    // Estado da aplicação
    const appState = {
      subRedesGeradas: [],
      subRedesExibidas: 0,
      selectedBlock: null,
      currentIpOffset: 0,
      mainBlock: null,
      mainBlockCurrentOffset: 0,
      isMainBlockIpsVisible: false,
      currentStep: 1
    };
    
    // Utilitários IPv6
    const utils = {
      // Validar IPv6 com prefixo
      isValidIPv6: function(addressCIDR) {
        try {
          let [addr, prefix] = addressCIDR.split('/');
          if (!prefix || isNaN(prefix)) return false;
          const prefixNum = parseInt(prefix);
          if (prefixNum < 1 || prefixNum > 128) return false;
          const expanded = this.expandIPv6Address(addressCIDR);
          if (expanded.startsWith("Erro")) return false;
          const regex = /^([0-9a-fA-F]{1,4}:){7}([0-9a-fA-F]{1,4})$/;
          return regex.test(expanded);
        } catch (error) {
          console.error("Erro ao validar IPv6:", error);
          return false;
        }
      },
      
      // Validar e retornar mensagem de erro
      validateIPv6: function(addressCIDR) {
        try {
          const [addr, prefix] = addressCIDR.split('/');
          if (!addr || !prefix || isNaN(prefix)) {
            return "Por favor, insira um endereço IPv6 válido no formato CIDR (ex.: 2001:db8::/41).";
          }
          const prefixNum = parseInt(prefix);
          if (prefixNum < 1 || prefixNum > 128) {
            return "O prefixo inicial deve estar entre 1 e 128.";
          }
          const enderecoCompleto = this.expandIPv6Address(addressCIDR);
          if (enderecoCompleto.startsWith("Erro")) {
            return enderecoCompleto;
          }
          const groups = enderecoCompleto.split(':');
          for (let i = 0; i < groups.length; i++) {
            if (!/^[0-9a-fA-F]{4}$/.test(groups[i])) {
              return `Grupo ${i + 1} contém caracteres inválidos ou possui comprimento incorreto.`;
            }
          }
          return null;
        } catch (error) {
          console.error("Erro ao validar IPv6 com detalhes:", error);
          return "Erro ao processar o endereço IPv6.";
        }
      },
      
      // Expandir IPv6
      expandIPv6Address: function(addressCIDR) {
        try {
          let [addr, prefix] = addressCIDR.split('/');
          if (!addr) return "Erro: Endereço inválido.";
          let parts = addr.split("::");
          if (parts.length > 2) {
            return "Erro: Não pode haver mais de um '::'.";
          }
          let head = parts[0] ? parts[0].split(':') : [];
          let tail = parts.length === 2 && parts[1] ? parts[1].split(':') : [];
          let missing = 8 - (head.length + tail.length);
          if (missing < 0) return "Erro: Muitos grupos de hexadecimais.";
          let zeros = new Array(missing).fill("0000");
          let fullParts = head.concat(zeros).concat(tail);
          for (let i = 0; i < fullParts.length; i++) {
            if (!/^[0-9a-fA-F]{1,4}$/.test(fullParts[i])) {
              return `Erro: Grupo ${i + 1} contém caracteres inválidos.`;
            }
            fullParts[i] = fullParts[i].padStart(4, '0');
          }
          return fullParts.join(':');
        } catch (error) {
          console.error("Erro ao expandir IPv6:", error);
          return "Erro: Falha ao processar o endereço.";
        }
      },
      
      // Encurtar IPv6
      shortenIPv6: function(address) {
        try {
          let groups = address.split(':').map(g => g.replace(/^0+/, '') || '0');
          let bestStart = -1, bestLen = 0;
          let curStart = -1, curLen = 0;
          for (let i = 0; i < groups.length; i++) {
            if (groups[i] === '0') {
              if (curStart === -1) {
                curStart = i;
                curLen = 1;
              } else {
                curLen++;
              }
            } else {
              if (curLen > bestLen) {
                bestLen = curLen;
                bestStart = curStart;
              }
              curStart = -1;
              curLen = 0;
            }
          }
          if (curLen > bestLen) {
            bestLen = curLen;
            bestStart = curStart;
          }
          if (bestLen < 2) {
            return groups.join(':');
          }
          let prefix = groups.slice(0, bestStart);
          let suffix = groups.slice(bestStart + bestLen);
          let result = '';
          if (prefix.length > 0) {
            result = prefix.join(':') + ':';
          }
          result += ':';
          if (suffix.length > 0) {
            result += suffix.join(':');
          }
          result = result.replace(/:{3,}/, '::');
          return result;
        } catch (error) {
          console.error("Erro ao encurtar IPv6:", error);
          return address; // Retorna o endereço original em caso de erro
        }
      },
      
      // Formatar IPv6 como string hexadecimal
      formatIPv6Address: function(ipv6BigInt) {
        try {
          let hexStr = ipv6BigInt.toString(16).padStart(32, '0');
          return hexStr.match(/.{1,4}/g).join(':');
        } catch (error) {
          console.error("Erro ao formatar IPv6 BigInt:", error);
          return "0000:0000:0000:0000:0000:0000:0000:0000"; // Retorna endereço zero em caso de erro
        }
      },
      
      // Calcular bloco agregado
      calcularBlocoAgregado: function(selectedSubnets) {
        try {
          if (selectedSubnets.length === 0) return null;
          let prefixLength = parseInt(selectedSubnets[0].subnet.split('/')[1]);
          for (let s of selectedSubnets) {
            let p = parseInt(s.subnet.split('/')[1]);
            if (p !== prefixLength) return null;
          }
          let networks = selectedSubnets.map(s => BigInt("0x" + s.network.replace(/:/g, '')));
          networks.sort((a, b) => (a < b ? -1 : a > b ? 1 : 0));
          let blockSize = 1n << (128n - BigInt(prefixLength));
          for (let i = 1; i < networks.length; i++) {
            if (networks[i] !== networks[i - 1] + blockSize) return null;
          }
          let n = BigInt(selectedSubnets.length);
          if ((n & (n - 1n)) !== 0n) return null;
          let bitsToRemove = 0;
          while ((1n << BigInt(bitsToRemove)) < n) {
            bitsToRemove++;
          }
          let newPrefix = prefixLength - bitsToRemove;
          if (newPrefix < 1) return null;
          let aggregatedNetwork = networks[0];
          let aggregatedHex = aggregatedNetwork.toString(16).padStart(32, '0');
          let aggregatedFormatted = aggregatedHex.match(/.{1,4}/g).join(':');
          return { network: aggregatedFormatted, prefix: newPrefix };
        } catch (error) {
          console.error("Erro ao calcular bloco agregado:", error);
          return null;
        }
      },
      
      // Gerar sub-redes assincronamente
      gerarSubRedesAssincronamente: function(ipv6BigInt, initialMask, prefix, numSubRedes, callback) {
        try {
          let i = 0n;
          const chunkSize = 1000n;
          const subRedesGeradas = [];
          
          function processChunk() {
            let chunkCount = 0n;
            while (i < numSubRedes && chunkCount < chunkSize) {
              let subnetBigInt = (ipv6BigInt & initialMask) + (i << (128n - BigInt(prefix)));
              let subnetHex = subnetBigInt.toString(16).padStart(32, '0');
              let subnetFormatada = subnetHex.match(/.{1,4}/g).join(':');
              let subnetInitial = subnetBigInt;
              let subnetFinal = subnetBigInt + (1n << (128n - BigInt(prefix))) - 1n;
              let subnetInitialFormatted = subnetInitial.toString(16).padStart(32, '0').match(/.{1,4}/g).join(':');
              let subnetFinalFormatted = subnetFinal.toString(16).padStart(32, '0').match(/.{1,4}/g).join(':');
              
              subRedesGeradas.push({
                subnet: `${subnetFormatada}/${prefix}`,
                initial: subnetInitialFormatted,
                final: subnetFinalFormatted,
                network: `${subnetFormatada}`
              });
              
              i++;
              chunkCount++;
            }
            
            if (i < numSubRedes) {
              setTimeout(processChunk, 0);
            } else {
              document.getElementById('loadingIndicator').style.display = 'none';
              callback(subRedesGeradas);
            }
          }
          
          processChunk();
        } catch (error) {
          console.error("Erro ao gerar sub-redes:", error);
          document.getElementById('loadingIndicator').style.display = 'none';
          alert("Erro ao gerar sub-redes: " + error.message);
        }
      }
    };
    
    // Funções de interface
    const ui = {
      // Atualizar passo atual
      updateStep: function(step) {
        document.querySelectorAll('.step').forEach(el => el.classList.remove('active'));
        document.getElementById(`step${step}`).classList.add('active');
        appState.currentStep = step;
      },
      
      // Copiar texto para clipboard
      copiarTexto: function(elementId) {
        const element = document.getElementById(elementId);
        if (!element) return;
        
        let text = element.innerText;
        
        navigator.clipboard.writeText(text)
          .then(() => {
            const btn = element.nextElementSibling;
            if (btn) {
              const originalIcon = btn.innerHTML;
              btn.innerHTML = '<i class="fas fa-check"></i>';
              setTimeout(() => {
                btn.innerHTML = originalIcon;
              }, 1500);
            }
          })
          .catch(error => {
            console.error("Erro ao copiar para clipboard:", error);
            alert("Falha ao copiar o texto.");
          });
      },
      
      // Adicionar IP à lista
      appendIpToList: function(ip, number, listId) {
        const ipsList = document.getElementById(listId);
        if (!ipsList) return;
        
        const li = document.createElement('li');
        li.className = 'ip-item';
        
        const numberSpan = document.createElement('span');
        numberSpan.className = 'ip-number';
        numberSpan.textContent = `${number}.`;
        
        const ipSpan = document.createElement('span');
        ipSpan.className = 'ip-text';
        ipSpan.textContent = ip;
        
        const copyBtn = document.createElement('button');
        copyBtn.className = 'copy-btn';
        copyBtn.innerHTML = '<i class="fas fa-copy"></i>';
        copyBtn.title = "Copiar IP";
        copyBtn.addEventListener('click', () => {
          navigator.clipboard.writeText(ip)
            .then(() => {
              copyBtn.innerHTML = '<i class="fas fa-check"></i>';
              setTimeout(() => {
                copyBtn.innerHTML = '<i class="fas fa-copy"></i>';
              }, 1500);
            })
            .catch(() => alert("Falha ao copiar IP."));
        });
        
        li.appendChild(numberSpan);
        li.appendChild(ipSpan);
        li.appendChild(copyBtn);
        ipsList.appendChild(li);
      },
      
      // Alternar tema
      toggleTheme: function() {
        document.body.classList.toggle('dark-mode');
        const themeBtn = document.getElementById('toggleThemeBtn');
        if (themeBtn) {
          if (document.body.classList.contains('dark-mode')) {
            themeBtn.innerHTML = '<i class="fas fa-sun"></i> Tema';
          } else {
            themeBtn.innerHTML = '<i class="fas fa-moon"></i> Tema';
          }
        }
      },
      
      // Carregar mais sub-redes na tabela
      carregarMaisSubRedes: function(startIndex, limit) {
        const tbody = document.querySelector('#subnetsTable tbody');
        if (!tbody) return;
        
        const endIndex = Math.min(startIndex + limit, appState.subRedesGeradas.length);
        
        for (let i = startIndex; i < endIndex; i++) {
          const row = tbody.insertRow();
          const checkboxCell = row.insertCell(0);
          const checkbox = document.createElement('input');
          checkbox.type = 'checkbox';
          checkbox.value = i;
          checkbox.setAttribute('aria-label', `Selecionar sub-rede ${utils.shortenIPv6(appState.subRedesGeradas[i].subnet)}`);
          
          checkbox.addEventListener('change', function() {
            ui.atualizarBlocoAgregado();
            ui.atualizarGerarIPsButton();
            ui.atualizarInformacoesDoBloco();
            
            row.classList.toggle('selected', checkbox.checked);
          });
          
          checkboxCell.appendChild(checkbox);
          row.insertCell(1).innerText = utils.shortenIPv6(appState.subRedesGeradas[i].subnet);
          row.insertCell(2).innerText = utils.shortenIPv6(appState.subRedesGeradas[i].initial);
          row.insertCell(3).innerText = utils.shortenIPv6(appState.subRedesGeradas[i].final);
          row.insertCell(4).innerText = utils.shortenIPv6(appState.subRedesGeradas[i].network);
        }
        
        appState.subRedesExibidas = endIndex;
        
        const loadMoreContainer = document.getElementById('loadMoreContainer');
        if (loadMoreContainer) {
          loadMoreContainer.style.display = 
            appState.subRedesExibidas < appState.subRedesGeradas.length ? 'block' : 'none';
        }
      },
      
      // Atualizar informações do bloco na sidebar
      atualizarInformacoesDoBloco: function() {
        const checkboxes = document.querySelectorAll('#subnetsTable tbody input[type="checkbox"]:checked');
        if (checkboxes.length === 1) {
          const indice = parseInt(checkboxes[0].value);
          const blocoSelecionado = appState.subRedesGeradas[indice];
          document.getElementById('sidebarBlockCidr').innerText = utils.shortenIPv6(blocoSelecionado.subnet);
          
          const redeHex = blocoSelecionado.network.replace(/:/g, '');
          const redeBigInt = BigInt("0x" + redeHex);
          const gatewayIpBigInt = redeBigInt + 1n; 
          const gatewayIpFormatado = utils.formatIPv6Address(gatewayIpBigInt);
          const gatewayIpShort = utils.shortenIPv6(gatewayIpFormatado);
          
          document.getElementById('mainBlockGateway').innerText = gatewayIpShort;
        }
      },
      
      // Atualizar bloco agregado
      atualizarBlocoAgregado: function() {
        const checkboxes = document.querySelectorAll('#subnetsTable tbody input[type="checkbox"]:checked');
        if (checkboxes.length === 0) {
          document.getElementById('aggregatedPrefix').innerText = "N/A";
          document.getElementById('aggregatedSidebar').style.display = 'none';
          return;
        }
        
        document.getElementById('aggregatedSidebar').style.display = 'block';
        const selectedSubnets = Array.from(checkboxes).map(checkbox => 
          appState.subRedesGeradas[parseInt(checkbox.value)]);
        
        const aggregate = utils.calcularBlocoAgregado(selectedSubnets);
        if (aggregate === null) {
          document.getElementById('aggregatedPrefix').innerText = "Bloco inválido";
        } else {
          document.getElementById('aggregatedPrefix').innerText = 
            utils.shortenIPv6(aggregate.network) + "/" + aggregate.prefix;
        }
      },
      
      // Atualizar botão gerar IPs
      atualizarGerarIPsButton: function() {
        const checkboxes = document.querySelectorAll('#subnetsTable tbody input[type="checkbox"]:checked');
        const btn = document.getElementById('gerarIPsButton');
        if (btn) {
          btn.style.display = (checkboxes.length === 1) ? 'inline-block' : 'none';
        }
      },
      
      // Inicializar gráficos de visualização
      initializeCharts: function() {
        // Inicializar gráfico de utilização
        const utilizationCtx = document.getElementById('utilizationChart').getContext('2d');
        const utilizationChart = new Chart(utilizationCtx, {
          type: 'bar',
          data: {
            labels: ['Grupo 1', 'Grupo 2', 'Grupo 3', 'Grupo 4', 'Grupo 5'],
            datasets: [{
              label: 'Número de Sub-redes',
              data: [12, 19, 3, 5, 2],
              backgroundColor: [
                'rgba(0, 112, 209, 0.7)',
                'rgba(76, 175, 80, 0.7)',
                'rgba(255, 160, 0, 0.7)',
                'rgba(229, 57, 53, 0.7)',
                'rgba(156, 39, 176, 0.7)'
              ],
              borderColor: [
                'rgba(0, 112, 209, 1)',
                'rgba(76, 175, 80, 1)',
                'rgba(255, 160, 0, 1)',
                'rgba(229, 57, 53, 1)',
                'rgba(156, 39, 176, 1)'
              ],
              borderWidth: 1
            }]
          },
          options: {
            responsive: true,
            plugins: {
              title: {
                display: true,
                text: 'Distribuição de Sub-redes IPv6'
              },
              legend: {
                display: false
              }
            },
            scales: {
              y: {
                beginAtZero: true
              }
            }
          }
        });
        
        // Inicializar mapa de calor com D3
        this.initHeatmapChart();
        
        // Inicializar gráfico de comparação de prefixos
        const comparisonCtx = document.getElementById('prefixComparisonChart').getContext('2d');
        const comparisonChart = new Chart(comparisonCtx, {
          type: 'bar',
          data: {
            labels: ['/48', '/52', '/56', '/60', '/64'],
            datasets: [
              {
                label: 'Número de Sub-redes',
                data: [2, 16, 256, 4096, 65536],
                backgroundColor: 'rgba(0, 112, 209, 0.5)',
                borderColor: 'rgba(0, 112, 209, 1)',
                borderWidth: 1,
                yAxisID: 'y'
              },
              {
                label: 'IPs por Sub-rede (log10)',
                data: [20, 19, 18, 17, 16],
                backgroundColor: 'rgba(76, 175, 80, 0.5)',
                borderColor: 'rgba(76, 175, 80, 1)',
                borderWidth: 1,
                yAxisID: 'y1',
                type: 'line'
              }
            ]
          },
          options: {
            responsive: true,
            plugins: {
              title: {
                display: true,
                text: 'Comparação de Tamanhos de Prefixo IPv6'
              }
            },
            scales: {
              y: {
                type: 'logarithmic',
                position: 'left',
                title: {
                  display: true,
                  text: 'Número de Sub-redes'
                }
              },
              y1: {
                type: 'linear',
                position: 'right',
                title: {
                  display: true,
                  text: 'IPs por Sub-rede (log10)'
                },
                grid: {
                  drawOnChartArea: false
                }
              }
            }
          }
        });
        
        // Atualizar estatísticas na visualização
        document.getElementById('statSubredes').textContent = '65.536';
        document.getElementById('statIps').textContent = '18.446 × 10^12';
        document.getElementById('statTotal').textContent = '1.208 × 10^18';
      },
      
      // Inicializar mapa de calor
      initHeatmapChart: function() {
        // Verificar se D3 está carregado
        if (!window.d3) {
          console.error("D3.js não está disponível");
          return;
        }
        
        const container = document.getElementById('heatmapChart');
        if (!container) return;
        
        // Limpar o container
        container.innerHTML = '';
        
        // Definir dimensões
        const margin = { top: 30, right: 30, bottom: 50, left: 50 };
        const width = container.clientWidth - margin.left - margin.right;
        const height = 300 - margin.top - margin.bottom;
        
        // Dados de exemplo para o mapa de calor
        const data = [];
        const dimension = 8;
        
        for (let y = 0; y < dimension; y++) {
          for (let x = 0; x < dimension; x++) {
            data.push({
              x: x,
              y: y,
              value: Math.floor(Math.random() * 10) // Valores aleatórios para demonstração
            });
          }
        }
        
        // Criar SVG
        const svg = d3.select(container)
          .append("svg")
            .attr("width", width + margin.left + margin.right)
            .attr("height", height + margin.top + margin.bottom)
          .append("g")
            .attr("transform", `translate(${margin.left},${margin.top})`);
        
        // Definir escalas
        const x = d3.scaleBand()
          .range([0, width])
          .domain(Array.from({ length: dimension }, (_, i) => i))
          .padding(0.01);
        
        const y = d3.scaleBand()
          .range([height, 0])
          .domain(Array.from({ length: dimension }, (_, i) => i))
          .padding(0.01);
        
        // Definir escala de cores
        const colorScale = d3.scaleSequential()
          .interpolator(d3.interpolateYlOrRd)
          .domain([0, 10]);
        
        // Adicionar eixos
        svg.append("g")
          .attr("transform", `translate(0,${height})`)
          .call(d3.axisBottom(x));
        
        svg.append("g")
          .call(d3.axisLeft(y));
        
        // Adicionar retângulos
        svg.selectAll()
          .data(data)
          .enter()
          .append("rect")
            .attr("x", d => x(d.x))
            .attr("y", d => y(d.y))
            .attr("width", x.bandwidth())
            .attr("height", y.bandwidth())
            .style("fill", d => colorScale(d.value));
      }
    };
    
    // ====== Funções principais da calculadora ======
    
    // Calcular sub-redes
    function calcularSubRedes() {
      // Limpar estado anterior
      appState.subRedesGeradas = [];
      appState.subRedesExibidas = 0;
      appState.selectedBlock = null;
      appState.currentIpOffset = 0;
      
      document.getElementById('resultado').style.display = 'none';
      document.getElementById('ipsResult').style.display = 'none';
      document.getElementById('visualizationSection').style.display = 'none';
      document.getElementById('ipsList').innerHTML = '';
      
      // Obter e validar o endereço IPv6
      const ipv6Input = document.getElementById('ipv6').value.trim();
      const errorMessage = utils.validateIPv6(ipv6Input);
      document.getElementById('errorMessage').style.display = 'none';
      
      if (errorMessage) {
        document.getElementById('errorMessage').innerText = errorMessage;
        document.getElementById('errorMessage').style.display = 'block';
        return;
      }
      
      // Configurar o bloco principal
      const [endereco, prefixoInicial] = ipv6Input.split('/');
      const prefixoNum = parseInt(prefixoInicial);
      const enderecoCompleto = utils.expandIPv6Address(ipv6Input);
      
      const enderecoFormatado = utils.shortenIPv6(enderecoCompleto);
      document.getElementById('mainBlockCidr').innerText = `${enderecoFormatado}/${prefixoNum}`;
      
      appState.mainBlock = {
        network: enderecoCompleto,
        prefix: prefixoNum
      };
      
      // Calcular o gateway
      const redeHex = enderecoCompleto.replace(/:/g, '');
      const redeBigInt = BigInt("0x" + redeHex);
      const gatewayIpBigInt = redeBigInt + 1n; 
      const gatewayIpFormatado = utils.formatIPv6Address(gatewayIpBigInt);
      const gatewayIpShort = utils.shortenIPv6(gatewayIpFormatado);
      
      document.getElementById('mainBlockGateway').innerText = gatewayIpShort;
      document.getElementById('sidebarBlockCidr').innerText = `${enderecoFormatado}/${prefixoNum}`;
      
      // Resetar o estado da lista de IPs
      appState.mainBlockCurrentOffset = 0;
      appState.isMainBlockIpsVisible = false;
      document.getElementById('mainBlockIpsContainer').style.display = 'none';
      document.getElementById('mainBlockIpsList').innerHTML = '';
      
      // Mostrar a seção do bloco principal e a sidebar
      document.getElementById('mainBlockSection').style.display = 'block';
      document.getElementById('infoSidebar').style.display = 'block';
      document.getElementById('suggestions').style.display = 'none';
      document.getElementById('aggregatedSidebar').style.display = 'none';
      
      // Atualizar os passos de progresso
      ui.updateStep(2);
      
      // Preencher a lista de prefixos possíveis
      document.getElementById('possiblePrefixesList').innerHTML = "";
      
      // Mostrar no máximo 20 prefixos para não sobrecarregar a interface
      const maxPrefixesToShow = Math.min(20, 128 - prefixoNum);
      
      for (let i = prefixoNum + 1; i <= prefixoNum + maxPrefixesToShow; i++) {
        const div = document.createElement('div');
        div.className = 'prefix-item';
        div.innerText = `/${i}`;
        div.addEventListener('click', () => selecionarPrefixo(i));
        document.getElementById('possiblePrefixesList').appendChild(div);
      }
    }
    
    // Resetar calculadora
    function resetarCalculadora() {
      document.getElementById('ipv6').value = '';
      document.getElementById('mainBlockSection').style.display = 'none';
      document.getElementById('suggestions').style.display = 'none';
      document.getElementById('resultado').style.display = 'none';
      document.getElementById('aggregatedSidebar').style.display = 'none';
      document.getElementById('infoSidebar').style.display = 'none';
      document.getElementById('loadingIndicator').style.display = 'none';
      document.getElementById('errorMessage').style.display = 'none';
      document.getElementById('visualizationSection').style.display = 'none';
      
      // Reiniciar variáveis
      appState.subRedesGeradas = [];
      appState.subRedesExibidas = 0;
      appState.selectedBlock = null;
      appState.currentIpOffset = 0;
      appState.mainBlock = null;
      appState.mainBlockCurrentOffset = 0;
      appState.isMainBlockIpsVisible = false;
      
      // Limpar listas
      document.getElementById('ipsList').innerHTML = '';
      document.getElementById('mainBlockIpsList').innerHTML = '';
      
      // Voltar para o primeiro passo
      ui.updateStep(1);
      
      // Focar no campo de entrada
      document.getElementById('ipv6').focus();
    }
    
    // Alternar visibilidade dos IPs do bloco principal
    function toggleMainBlockIps() {
      const ipsContainer = document.getElementById('mainBlockIpsContainer');
      const toggleBtn = document.getElementById('toggleMainBlockIpsBtn');
      
      if (appState.isMainBlockIpsVisible) {
        ipsContainer.style.display = 'none';
        toggleBtn.innerHTML = '<i class="fas fa-list"></i> Exibir IPs';
        appState.isMainBlockIpsVisible = false;
      } else {
        ipsContainer.style.display = 'block';
        toggleBtn.innerHTML = '<i class="fas fa-times"></i> Fechar IPs';
        appState.isMainBlockIpsVisible = true;
        
        if (document.getElementById('mainBlockIpsList').innerHTML === '') {
          gerarIPsDoBloco();
        }
      }
    }
    
    // Mostrar sugestões de divisão
    function mostrarSugestoesDivisao() {
      document.getElementById('suggestions').style.display = 'block';
      document.getElementById('suggestions').scrollIntoView({ behavior: 'smooth' });
    }
    
    // Gerar IPs do bloco principal
    function gerarIPsDoBloco() {
      if (!appState.mainBlock) return;
      
      const toggleBtn = document.getElementById('toggleMainBlockIpsBtn');
      toggleBtn.disabled = true;
      toggleBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Gerando...';
      
      const redeCompleta = appState.mainBlock.network;
      const redeHex = redeCompleta.replace(/:/g, '');
      const redeBigInt = BigInt("0x" + redeHex);
      const ipsList = document.getElementById('mainBlockIpsList');
      ipsList.innerHTML = "";
      appState.mainBlockCurrentOffset = 0;
      
      function processarLote() {
        const limite = Math.min(appState.mainBlockCurrentOffset + 10, 50);
        for (let i = appState.mainBlockCurrentOffset; i < limite; i++) {
          const ipBigInt = redeBigInt + BigInt(i);
          const ipFormatado = utils.formatIPv6Address(ipBigInt);
          const ipEnd = utils.shortenIPv6(ipFormatado);
          ui.appendIpToList(ipEnd, i + 1, 'mainBlockIpsList');
        }
        
        appState.mainBlockCurrentOffset = limite;
        
        if (appState.mainBlockCurrentOffset < 50) {
          setTimeout(processarLote, 0);
        } else {
          toggleBtn.disabled = false;
          toggleBtn.innerHTML = '<i class="fas fa-times"></i> Fechar IPs';
        }
      }
      
      processarLote();
    }
    
    // Gerar mais IPs do bloco principal
    function gerarMaisIPsDoBloco() {
      if (!appState.mainBlock) return;
      
      const btn = document.getElementById('moreMainBlockIpsBtn');
      btn.disabled = true;
      btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Gerando...';
      
      const redeCompleta = appState.mainBlock.network;
      const redeHex = redeCompleta.replace(/:/g, '');
      const redeBigInt = BigInt("0x" + redeHex);
      const inicio = appState.mainBlockCurrentOffset;
      const fim = inicio + 50;
      
      function processarLote() {
        const limite = Math.min(appState.mainBlockCurrentOffset + 10, fim);
        for (let i = appState.mainBlockCurrentOffset; i < limite; i++) {
          const ipBigInt = redeBigInt + BigInt(i);
          const ipFormatado = utils.formatIPv6Address(ipBigInt);
          const ipEnd = utils.shortenIPv6(ipFormatado);
          ui.appendIpToList(ipEnd, i + 1, 'mainBlockIpsList');
        }
        
        appState.mainBlockCurrentOffset = limite;
        
        if (appState.mainBlockCurrentOffset < fim) {
          setTimeout(processarLote, 0);
        } else {
          btn.disabled = false;
          btn.innerHTML = '<i class="fas fa-plus"></i> Gerar Mais 50 IPs';
        }
      }
      
      processarLote();
    }
    
    // Resetar IPs do bloco principal
    function resetarIPsMainBlock() {
      appState.mainBlockCurrentOffset = 0;
      document.getElementById('mainBlockIpsList').innerHTML = '';
      document.getElementById('moreMainBlockIpsBtn').disabled = false;
      document.getElementById('moreMainBlockIpsBtn').innerHTML = '<i class="fas fa-plus"></i> Gerar Mais 50 IPs';
    }
    
    // Selecionar prefixo
    function selecionarPrefixo(prefix) {
      const ipv6Input = document.getElementById('ipv6').value.trim();
      const [endereco, prefixoInicial] = ipv6Input.split('/');
      const prefixoNum = parseInt(prefixoInicial);
      
      if (prefix <= prefixoNum) {
        alert("O prefixo selecionado deve ser maior que o prefixo inicial.");
        return;
      }
      
      const enderecoCompleto = utils.expandIPv6Address(ipv6Input);
      if (enderecoCompleto.startsWith("Erro")) {
        alert(enderecoCompleto);
        return;
      }
      
      // Atualizar o passo atual
      ui.updateStep(3);
      
      // Mostrar indicador de carregamento
      document.getElementById('loadingIndicator').style.display = 'flex';
      document.getElementById('suggestions').style.display = 'none';
      
      // Processar o endereço IPv6
      const ipv6SemDoisPontos = enderecoCompleto.replace(/:/g, '');
      const ipv6BigInt = BigInt("0x" + ipv6SemDoisPontos);
      const bitsAdicionais = prefix - prefixoNum;
      const numSubRedes = 1n << BigInt(bitsAdicionais);
      
      // Limpar tabela existente
      appState.subRedesGeradas = [];
      appState.subRedesExibidas = 0;
      document.getElementById('subnetsTable').getElementsByTagName('tbody')[0].innerHTML = "";
      
      // Máscara inicial para o cálculo
      const initialMask = ((1n << BigInt(prefixoNum)) - 1n) << (128n - BigInt(prefixoNum));
      
      // Gerar sub-redes assincronamente
      setTimeout(() => {
        utils.gerarSubRedesAssincronamente(ipv6BigInt, initialMask, prefix, numSubRedes, (subRedes) => {
          appState.subRedesGeradas = subRedes;
          ui.carregarMaisSubRedes(0, 100);
          
          document.getElementById('loadMoreContainer').style.display = 
            appState.subRedesGeradas.length > 100 ? 'block' : 'none';
          
          document.getElementById('resultado').style.display = 'block';
          document.getElementById('mainBlockSection').style.display = 'none';
          document.getElementById('aggregatedSidebar').style.display = 'none';
          document.getElementById('aggregatedPrefix').innerText = "N/A";
        });
      }, 50);
    }
    
    // Gerar IPs da sub-rede selecionada
    function gerarPrimeirosIPs() {
      const checkboxes = document.querySelectorAll('#subnetsTable tbody input[type="checkbox"]:checked');
      if (checkboxes.length !== 1) {
        alert("Selecione exatamente um bloco para gerar os IPs.");
        return;
      }
      
      // Resetar a lista de IPs
      resetarIPsGerados();
      
      const indice = parseInt(checkboxes[0].value);
      appState.selectedBlock = appState.subRedesGeradas[indice];
      appState.currentIpOffset = 0;
      
      const redeCompleta = appState.selectedBlock.network;
      const redeHex = redeCompleta.replace(/:/g, '');
      const redeBigInt = BigInt("0x" + redeHex);
      const ipsList = document.getElementById('ipsList');
      ipsList.innerHTML = "";
      
      for (let i = 0; i < 50; i++) {
        const ipBigInt = redeBigInt + BigInt(i);
        const ipFormatado = utils.formatIPv6Address(ipBigInt);
        const ipEnd = utils.shortenIPv6(ipFormatado);
        ui.appendIpToList(ipEnd, i + 1, 'ipsList');
      }
      
      appState.currentIpOffset = 50;
      document.getElementById('ipsResult').style.display = 'block';
      document.getElementById('ipsResult').scrollIntoView({ behavior: 'smooth' });
    }
    
    // Gerar mais IPs
    function gerarMaisIPs() {
      if (!appState.selectedBlock) return;
      
      const redeCompleta = appState.selectedBlock.network;
      const redeHex = redeCompleta.replace(/:/g, '');
      const redeBigInt = BigInt("0x" + redeHex);
      const inicio = appState.currentIpOffset;
      const fim = inicio + 50;
      
      // Desabilitar o botão enquanto processa
      const btn = document.getElementById('gerarMaisIPsButton');
      btn.disabled = true;
      btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Gerando...';
      
      function processarLote() {
        const limite = Math.min(appState.currentIpOffset + 10, fim);
        for (let i = appState.currentIpOffset; i < limite; i++) {
          const ipBigInt = redeBigInt + BigInt(i);
          const ipFormatado = utils.formatIPv6Address(ipBigInt);
          const ipEnd = utils.shortenIPv6(ipFormatado);
          ui.appendIpToList(ipEnd, i + 1, 'ipsList');
        }
        
        appState.currentIpOffset = limite;
        
        if (appState.currentIpOffset < fim) {
          setTimeout(processarLote, 0);
        } else {
          btn.disabled = false;
          btn.innerHTML = '<i class="fas fa-plus"></i> Gerar Mais 50 IPs';
        }
      }
      
      processarLote();
    }
    
    // Resetar IPs gerados
    function resetarIPsGerados() {
      appState.currentIpOffset = 0;
      document.getElementById('ipsList').innerHTML = '';
    }
    
    // Mostrar visualização
    function mostrarVisualizacao() {
      // Verificar se há sub-redes geradas
      if (appState.subRedesGeradas.length === 0) {
        alert("Gere sub-redes primeiro para poder visualizar os dados.");
        return;
      }
      
      // Atualizar o passo atual
      ui.updateStep(4);
      
      // Exibir a seção de visualização
      document.getElementById('visualizationSection').style.display = 'block';
      document.getElementById('visualizationSection').scrollIntoView({ behavior: 'smooth' });
      
      // Inicializar os gráficos
      ui.initializeCharts();
    }
    
    // Selecionar/deselecionar todos os checkboxes
    function toggleSelectAll() {
      const selectAll = document.getElementById('selectAll');
      if (!selectAll) return;
      
      const checkboxes = document.querySelectorAll('#subnetsTable tbody input[type="checkbox"]');
      const isChecked = selectAll.checked;
      
      checkboxes.forEach(checkbox => {
        checkbox.checked = isChecked;
        
        // Disparar evento change para atualizar linhas selecionadas
        const changeEvent = new Event('change');
        checkbox.dispatchEvent(changeEvent);
      });
    }
    
    // ====== Inicialização e configuração de eventos ======
    document.addEventListener('DOMContentLoaded', function() {
      // Configurar evento de tema
      if (window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches) {
        ui.toggleTheme();
      }
      
      // Associar eventos aos botões
      document.getElementById('calcularBtn').addEventListener('click', calcularSubRedes);
      document.getElementById('resetBtn').addEventListener('click', resetarCalculadora);
      document.getElementById('toggleThemeBtn').addEventListener('click', ui.toggleTheme);
      document.getElementById('toggleMainBlockIpsBtn').addEventListener('click', toggleMainBlockIps);
      document.getElementById('continuarBtn').addEventListener('click', mostrarSugestoesDivisao);
      document.getElementById('moreMainBlockIpsBtn').addEventListener('click', gerarMaisIPsDoBloco);
      document.getElementById('resetMainBlockIPsButton').addEventListener('click', resetarIPsMainBlock);
      document.getElementById('loadMoreButton').addEventListener('click', function() {
        ui.carregarMaisSubRedes(appState.subRedesExibidas, 100);
      });
      document.getElementById('selectAll').addEventListener('change', toggleSelectAll);
      document.getElementById('gerarIPsButton').addEventListener('click', gerarPrimeirosIPs);
      document.getElementById('gerarMaisIPsButton').addEventListener('click', gerarMaisIPs);
      document.getElementById('resetIPsButton').addEventListener('click', resetarIPsGerados);
      document.getElementById('visualizarBtn').addEventListener('click', mostrarVisualizacao);
      
      // Configurar eventos de navegação
      document.getElementById('topBtn').addEventListener('click', function() {
        window.scrollTo({ top: 0, behavior: 'smooth' });
      });
      
      document.getElementById('bottomBtn').addEventListener('click', function() {
        window.scrollTo({ top: document.body.scrollHeight, behavior: 'smooth' });
      });
      
      // Configurar eventos para abas de visualização
      document.querySelectorAll('.tab').forEach(tab => {
        tab.addEventListener('click', function() {
          // Remover classe ativa de todas as abas
          document.querySelectorAll('.tab').forEach(t => t.classList.remove('tab-active'));
          this.classList.add('tab-active');
          
          // Ocultar todos os conteúdos
          document.querySelectorAll('.tab-content').forEach(content => {
            content.classList.remove('active');
          });
          
          // Mostrar o conteúdo correspondente
          const contentId = this.id.replace('Tab', 'Content');
          document.getElementById(contentId).classList.add('active');
        });
      });
      
      // Configurar evento do slider de prefixo
      document.getElementById('prefixSlider').addEventListener('input', function() {
        document.getElementById('prefixValue').textContent = this.value;
        
        // Atualizar estatísticas com valores fictícios para demonstração
        const prefix = parseInt(this.value);
        const basePrefix = 48; // Valor de exemplo
        const bitsAdicionais = prefix - basePrefix;
        
        if (bitsAdicionais > 0) {
          const numSubRedes = 2 ** bitsAdicionais;
          const ipsPerSubnet = 2 ** (128 - prefix);
          
          document.getElementById('statSubredes').textContent = numSubRedes.toLocaleString();
          document.getElementById('statIps').textContent = ipsPerSubnet.toExponential(2);
          document.getElementById('statTotal').textContent = (numSubRedes * ipsPerSubnet).toExponential(2);
        }
      });
      
      // Exportar funções para uso global
      window.copiarTexto = ui.copiarTexto;
      
      console.log("Interface da calculadora IPv6 inicializada com sucesso!");
    });
  </script>
</body>
</html>