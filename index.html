<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Calculadora IPv6 - Gerador de Sub-redes</title>
  <meta name="description" content="Ferramenta online para c√°lculo e visualiza√ß√£o de sub-redes IPv6">
  
  <!-- Favicon inline para evitar requests 404 -->
  <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>üåê</text></svg>" type="image/svg+xml">
  
  <!-- CSS consolidado - ordem otimizada -->
  <link rel="stylesheet" href="css/main.css">
  <link rel="stylesheet" href="css/dark-mode.css">
  <link rel="stylesheet" href="css/enhanced-ui.css">
  <link rel="stylesheet" href="css/ui-fixes.css">
  <link rel="stylesheet" href="css/network-panel.css">
  <link rel="stylesheet" href="css/overlap-checker.css">
  <link rel="stylesheet" href="css/network-modal-styles.css">
  
  <!-- Font Awesome para √≠cones -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  
  <!-- Meta tags adicionais -->
  <meta name="theme-color" content="#0070d1">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
</head>
<body>
  <!-- Alerta de erro para inicializa√ß√£o -->
  <div id="initErrorAlert" style="display: none; background-color: #f8d7da; color: #721c24; padding: 12px; margin: 10px; border-radius: 4px; border: 1px solid #f5c6cb;">
    <strong>Erro ao inicializar:</strong> <span id="initErrorMessage"></span>
    <button onclick="window.location.reload()" style="background: #dc3545; color: white; border: none; padding: 5px 10px; margin-left: 10px; border-radius: 3px; cursor: pointer;">Recarregar</button>
  </div>

  <div class="container">
    <!-- Cabe√ßalho -->
    <header class="header">
      <h1>Calculadora IPv6</h1>
      <div class="header-buttons">
        <button id="networkConfigBtn" class="btn-primary">
          <i class="fas fa-network-wired"></i> Rede
        </button>
        <button id="toggleThemeBtn" class="btn-primary">
          <i class="fas fa-moon"></i> Tema
        </button>
        <button id="resetBtn" class="btn-primary">
          <i class="fas fa-redo-alt"></i> Limpar
        </button>
      </div>
    </header>
    
    <!-- Modal de Configura√ß√£o de Rede -->
    <div id="networkConfigModalOverlay" class="modal-overlay">
      <div id="networkConfigModal" class="modal" role="dialog" aria-modal="true" aria-labelledby="networkConfigModalTitle">
        <div class="modal-header">
          <h3 id="networkConfigModalTitle">Configura√ß√£o de Rede</h3>
          <button id="closeNetworkConfigModalBtn" class="modal-close-btn" aria-label="Fechar">
            <i class="fas fa-times"></i>
          </button>
        </div>
        <div class="modal-body">
          <p>Configure seus prefixos IPv6 para WAN e LAN.</p>
          
          <div class="field-group">
            <label for="modalWanPrefix">Prefixo WAN (CIDR):</label>
            <input type="text" id="modalWanPrefix" value="2804:418:3000:1::190/64" placeholder="Ex.: 2001:db8::/64" autocomplete="off">
            <div class="field-hint">Endere√ßo IPv6 da interface WAN no formato CIDR.</div>
          </div>
          
          <div class="field-group">
            <label for="modalLanPrefix">Prefixo LAN (CIDR):</label>
            <input type="text" id="modalLanPrefix" value="2804:418:3000:5::1/64" placeholder="Ex.: 2001:db8:1::/64" autocomplete="off">
            <div class="field-hint">Endere√ßo IPv6 da interface LAN no formato CIDR (usado para refer√™ncia).</div>
          </div>
          
          <button id="modalResolveConflictBtn" class="btn-primary">
            <i class="fas fa-magic"></i> Verificar Sobreposi√ß√£o
          </button>
          
          <div id="modalOverlapWarning" class="overlap-warning" style="display: none; margin-top: 20px;">
            <div class="warning-icon">‚ö†Ô∏è</div>
            <div class="warning-content">
              <h4>Sobreposi√ß√£o de blocos IPv6 detectada!</h4>
              <p>Os prefixos WAN e LAN est√£o em conflito.</p>
              <div class="suggested-prefix">
                <code id="modalSuggestedPrefix">-</code>
                <button id="modalApplyPrefixBtn" class="btn-primary">
                  <i class="fas fa-check"></i> Aplicar Sugest√£o
                </button>
              </div>
            </div>
          </div>
        </div>
        <div class="modal-footer">
          <button id="saveNetworkConfigBtn" class="btn-primary">
            <i class="fas fa-save"></i> Salvar
          </button>
          <button id="cancelNetworkConfigBtn" class="btn-secondary">
            Cancelar
          </button>
        </div>
      </div>
    </div>
    
    <!-- Indicador de passos -->
    <div class="steps">
      <div id="step1" class="step active">
        <div class="step-number">1</div>
        <div class="step-title">Inserir IPv6</div>
      </div>
      <div id="step2" class="step">
        <div class="step-number">2</div>
        <div class="step-title">Escolher Prefixo</div>
      </div>
      <div id="step3" class="step">
        <div class="step-number">3</div>
        <div class="step-title">Gerenciar Sub-redes</div>
      </div>
    </div>
    
    <!-- Layout principal -->
    <div class="main-layout">
      <div class="content">
        <!-- Formul√°rio inicial -->
        <div class="form-group">
          <label for="ipv6">Insira um endere√ßo IPv6 no formato CIDR:</label>
          <input type="text" id="ipv6" 
                 placeholder="Ex.: 2001:db8::/41" 
                 autocomplete="off" 
                 aria-describedby="errorMessage">
          <div id="errorMessage" class="error-message"></div>
          
          <div class="action-buttons">
            <button id="calcularBtn" class="btn-primary">
              <i class="fas fa-calculator"></i> Calcular Sub-redes
            </button>
          </div>
        </div>
        
        <!-- Bloco principal -->
        <div id="mainBlockSection" style="display: none;">
          <div class="card">
            <h3>Bloco IPv6 Principal</h3>
            <div class="info-item">
              <span class="info-label">CIDR:</span>
              <div class="info-value-container">
                <div id="mainBlockCidr" class="info-value">-</div>
                <button class="copy-btn" onclick="UIController.clipboard.copy(document.getElementById('mainBlockCidr'))">
                  <i class="fas fa-copy"></i>
                </button>
              </div>
            </div>
            
            <div class="action-buttons">
              <button id="toggleMainBlockIpsBtn" class="btn-primary">
                <i class="fas fa-list"></i> Exibir IPs
              </button>
              <button id="continuarBtn" class="btn-secondary">
                <i class="fas fa-angle-right"></i> Escolher Prefixo
              </button>
            </div>
            
            <div id="mainBlockIpsContainer" style="display: none;">
              <h4>Primeiros IPs dispon√≠veis neste bloco:</h4>
              <ul id="mainBlockIpsList" class="ip-list"></ul>
              <div class="action-buttons">
                <button id="moreMainBlockIpsBtn" class="btn-primary">
                  <i class="fas fa-plus"></i> Gerar Mais 50 IPs
                </button>
                <button id="resetMainBlockIPsButton" class="btn-secondary">
                  <i class="fas fa-redo-alt"></i> Resetar Lista
                </button>
                <button id="exportMainBlockIpsBtn" class="btn-secondary" style="display: none;">
                  <i class="fas fa-file-excel"></i> Exportar IPs
                </button>
              </div>
            </div>
          </div>
        </div>
        
        <!-- Sugest√µes de divis√£o -->
        <div id="suggestions" style="display: none;">
          <div class="card">
            <h3>Escolha um Prefixo para Divis√£o</h3>
            <p>Selecione o tamanho do prefixo para dividir o bloco em sub-redes:</p>
            <div id="possiblePrefixesList" class="prefixes-list"></div>
          </div>
        </div>
        
        <!-- Resultados -->
        <div id="resultado" style="display: none;">
          <div class="card">
            <h3>Sub-redes Geradas</h3>
            <div class="table-container">
              <table id="subnetsTable">
                <thead>
                  <tr>
                    <th width="50">
                      <input type="checkbox" id="selectAll" aria-label="Selecionar todas as sub-redes">
                    </th>
                    <th>Sub-rede</th>
                    <th>Inicial</th>
                    <th>Final</th>
                    <th>Rede</th>
                  </tr>
                </thead>
                <tbody></tbody>
              </table>
            </div>
            
            <div id="loadMoreContainer" style="display: none; text-align: center; margin-top: 16px;">
              <button id="loadMoreButton" class="btn-primary">
                <i class="fas fa-sync"></i> Carregar Mais Sub-redes
              </button>
            </div>
            
            <div class="action-buttons">
              <button id="gerarIPsButton" class="btn-primary" style="display: none;">
                <i class="fas fa-list"></i> Gerar IPs da Sub-rede
              </button>
              <button id="exportSubnetsTableBtn" class="btn-secondary" style="display: none;">
                <i class="fas fa-file-excel"></i> Exportar Tabela
              </button>
            </div>
          </div>
        </div>
        
        <!-- Lista de IPs da sub-rede selecionada -->
        <div id="ipsResult" style="display: none;">
          <div class="card">
            <h3>IPs da Sub-rede Selecionada</h3>
            <ul id="ipsList" class="ip-list"></ul>
            <div class="action-buttons">
              <button id="gerarMaisIPsButton" class="btn-primary">
                <i class="fas fa-plus"></i> Gerar Mais 50 IPs
              </button>
              <button id="resetIPsButton" class="btn-secondary">
                <i class="fas fa-redo-alt"></i> Resetar Lista
              </button>
              <button id="exportSubnetIpsBtn" class="btn-secondary" style="display: none;">
                <i class="fas fa-file-excel"></i> Exportar IPs
              </button>
            </div>
          </div>
        </div>
        
        <!-- Indicador de carregamento -->
        <div id="loadingIndicator" class="loader-container" style="display: none;">
          <div class="loader"></div>
          <div class="loading-message">Gerando sub-redes... Por favor, aguarde.</div>
        </div>
      </div>
      
      <!-- Sidebar para informa√ß√µes -->
      <div id="infoSidebar" class="sidebar" style="display: none;">
        <h3>Informa√ß√µes do Bloco</h3>
        <div class="info-item">
          <span class="info-label">CIDR:</span>
          <div class="info-value-container">
            <div id="sidebarBlockCidr" class="info-value">-</div>
            <button class="copy-btn" onclick="UIController.clipboard.copy(document.getElementById('sidebarBlockCidr'))">
              <i class="fas fa-copy"></i>
            </button>
          </div>
        </div>
        <div class="info-item">
          <span class="info-label">Gateway padr√£o:</span>
          <div class="info-value-container">
            <div id="mainBlockGateway" class="info-value">-</div>
            <button class="copy-btn" onclick="UIController.clipboard.copy(document.getElementById('mainBlockGateway'))">
              <i class="fas fa-copy"></i>
            </button>
          </div>
        </div>
        
        <div class="dns-item">
          <span class="dns-label">Google DNS</span>
          <div class="info-value-container">
            <div id="googleDNS" class="info-value">2001:4860:4860::8888</div>
            <button class="copy-btn" onclick="UIController.clipboard.copy('2001:4860:4860::8888')">
              <i class="fas fa-copy"></i>
            </button>
          </div>
        </div>
        
        <div class="dns-item">
          <span class="dns-label">Google DNS Alt</span>
          <div class="info-value-container">
            <div id="googleDNSAlt" class="info-value">2001:4860:4860::8844</div>
            <button class="copy-btn" onclick="UIController.clipboard.copy('2001:4860:4860::8844')">
              <i class="fas fa-copy"></i>
            </button>
          </div>
        </div>
        
        <div class="dns-item">
          <span class="dns-label">Cloudflare DNS</span>
          <div class="info-value-container">
            <div id="cloudflareDNS" class="info-value">2606:4700:4700::1111</div>
            <button class="copy-btn" onclick="UIController.clipboard.copy('2606:4700:4700::1111')">
              <i class="fas fa-copy"></i>
            </button>
          </div>
        </div>

        <!-- Conte√∫do para bloco agregado -->
        <div id="aggregatedContent" style="display: none; margin-top: 20px; padding-top: 20px; border-top: 1px solid var(--border-light);">
          <h3>Bloco Agregado</h3>
          <div class="info-item">
            <span class="info-label">Prefixo Agregado:</span>
            <div class="info-value-container">
              <div id="aggregatedPrefix" class="info-value">N/A</div>
              <button class="copy-btn" onclick="UIController.clipboard.copy(document.getElementById('aggregatedPrefix'))">
                <i class="fas fa-copy"></i>
              </button>
            </div>
          </div>
          <p class="info-desc">Este √© o bloco IPv6 que engloba todas as sub-redes selecionadas.</p>
        </div>
      </div>
    </div>
  </div>
  
  <!-- Bot√µes de navega√ß√£o fixados -->
  <div class="nav-buttons">
    <button id="topBtn" class="nav-btn" title="Ir para o topo">
      <i class="fas fa-arrow-up"></i>
    </button>
    <button id="bottomBtn" class="nav-btn" title="Ir para o final">
      <i class="fas fa-arrow-down"></i>
    </button>
  </div>
  
  <!-- Scripts em ordem otimizada para melhor performance -->
  
  <!-- 1. Utilit√°rios b√°sicos primeiro -->
  <script src="js/utils/dom-cache.js"></script>
  <script src="js/utils/module-manager.js"></script>
  
  <!-- 2. M√≥dulos principais de core -->
  <script src="js/core/ipv6-utils.js"></script>
  <script src="js/ui/ui-controller.js"></script>
  <script src="js/core/ipv6-calculator.js"></script>
  
  <!-- 3. Verifica√ß√µes de ambiente -->
  <script src="js/utils/env-check.js"></script>
  <script src="js/utils/debug-check.js"></script>
  
  <!-- 4. M√≥dulos de UI e componentes -->
  <script src="js/ui/ui-components.js"></script>
  <script src="js/ui/responsive-handler.js"></script>
  <script src="js/ui/ui-fixes.js"></script>
  
  <!-- 5. Biblioteca externa para Excel -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  
  <!-- 6. M√≥dulos de funcionalidades espec√≠ficas -->
  <script src="js/utils/excel-exporter.js"></script>
  <script src="js/ui/export-controller.js"></script>
  <script src="js/ui/overlap-checker.js"></script>
  <script src="js/ui/network-panel.js"></script>
  <script src="js/utils/modal-interactions.js"></script>
  
  <!-- 7. Scripts de integra√ß√£o -->
  <script src="js/overlap-integration.js"></script>
  
  <!-- 8. Melhorias e inicializa√ß√£o -->
  <script src="js/enhancements/enhanced-app.js"></script>
  
  <!-- 9. Script principal da aplica√ß√£o (por √∫ltimo) -->
  <script src="js/core/app.js"></script>

  <!-- Script de inicializa√ß√£o final -->
  <script>
    // Verifica√ß√£o final e configura√ß√£o global
    document.addEventListener('DOMContentLoaded', function() {
      console.log("üåê Calculadora IPv6 - Verifica√ß√£o final de inicializa√ß√£o");
      
      // Verificar m√≥dulos cr√≠ticos
      const criticalModules = ['IPv6Utils', 'UIController', 'IPv6Calculator'];
      const missingModules = criticalModules.filter(module => typeof window[module] === 'undefined');
      
      if (missingModules.length > 0) {
        console.error("‚ùå M√≥dulos cr√≠ticos n√£o carregados:", missingModules);
        const errorAlert = document.getElementById('initErrorAlert');
        const errorMessage = document.getElementById('initErrorMessage');
        
        if (errorAlert && errorMessage) {
          errorMessage.textContent = `M√≥dulos n√£o carregados: ${missingModules.join(', ')}. Recarregue a p√°gina.`;
          errorAlert.style.display = 'block';
        }
        return;
      }
      
      // Configurar fun√ß√£o global de c√≥pia para compatibilidade
      if (typeof window.copiarTexto === 'undefined' && window.UIController) {
        window.copiarTexto = function(elementId) {
          if (window.UIController.clipboard) {
            const element = document.getElementById(elementId);
            window.UIController.clipboard.copy(element);
          }
        };
      }
      
      // Verificar disponibilidade da biblioteca Excel
      if (typeof window.XLSX === 'undefined') {
        console.warn("‚ö†Ô∏è Biblioteca XLSX n√£o carregada - funcionalidade de exporta√ß√£o pode n√£o funcionar");
      }
      
      // Log final
      console.log("‚úÖ Calculadora IPv6 inicializada com sucesso!");
      console.log("üìä M√≥dulos carregados:", criticalModules.filter(m => window[m]).length + "/" + criticalModules.length);
      
      // Mostrar informa√ß√µes de debug se estiver em localhost
      if (location.hostname === 'localhost' || location.hostname === '127.0.0.1') {
        console.group("üîß Informa√ß√µes de Debug");
        console.log("Ambiente:", "Desenvolvimento");
        console.log("M√≥dulos dispon√≠veis:", Object.keys(window).filter(key => 
          ['IPv6Utils', 'UIController', 'IPv6Calculator', 'ModuleManager', 'DOMCache'].includes(key)
        ));
        console.log("Para diagn√≥stico completo execute: debugIPv6App.checkModules()");
        console.groupEnd();
      }
    });
    
    // Tratamento de erros globais
    window.addEventListener('error', function(e) {
      console.error("‚ùå Erro global capturado:", e.error);
      if (e.filename && e.filename.includes('ipv6')) {
        console.error("Erro relacionado √† Calculadora IPv6 detectado");
      }
    });
    
    // Evitar que erros de recursos n√£o cr√≠ticos quebrem a aplica√ß√£o
    window.addEventListener('unhandledrejection', function(e) {
      console.warn("‚ö†Ô∏è Promise rejeitada:", e.reason);
      // N√£o prevenir o comportamento padr√£o para promises cr√≠ticas
    });
  </script>
</body>
</html>
